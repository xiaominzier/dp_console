<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>编辑政策法规条例</title>
    <link rel="stylesheet" href="/staticResource/css/font.css">
    <link rel="stylesheet" href="/staticResource/css/xadmin.css">

</head>
<body>
<script type="text/javascript" src="/staticResource/lib/jsencrypt/jsencrypt.js"></script>
<script type="text/javascript" src="/staticResource/lib/jsencrypt/aes.mini.js"></script>
<script type="text/javascript" src="/staticResource/lib/common-js/jquery.min.js"></script>
<script src="/staticResource/lib/layui/layui.js" charset="utf-8"></script>
<script src="/staticResource/lib/common-js/xadmin.js" charset="utf-8">
</script>
<script src="/staticResource/lib/common-js/util.js"></script>
<script type="text/javascript" src="/staticResource/lib/layui/lay/modules/xm-select.js"></script>

<div class="layui-fluid" style="padding-top: 15px;padding-bottom: 15px;padding-left: 50px;padding-right: 50px">
    <form class="layui-form" id="formid" lay-filter="cooperForm">

        <style>
            .layui-form-label.layui-required:after {
                content: "*";
                color: red;
                position: absolute;
            }

        </style>

        <fieldset class="layui-elem-field" style="background-color: #fff;">
            <legend>政策法规信息</legend>
            <div class="layui-field-box">
                <div class="layui-form-item">
                    <label class="layui-form-label ">政策法规</label>
                    <div class="layui-input-block">
                        <div id="policiesRegulationsNameSelect" name="policiesRegulationsNameSelect"
                             class="xm-select-demo"></div>

                        <input type="hidden" name="policiesRegulationsName" id="policiesRegulationsName" autocomplete="off"
                               class="layui-input">
                        <input type="hidden" name="policiesId" id="policiesId" autocomplete="off"
                               class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">章</label>
                    <div class="layui-input-block">
                        <input type="text" name="chapter" lay-verify="required" autocomplete="off"
                               class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">条例内容</label>
                    <div class="layui-input-block">
                        <textarea name="measures" lay-verify="required" placeholder="请输入" class="layui-textarea"></textarea>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label ">关键词</label>
                    <div class="layui-input-block">
                        <input type="text" name="keywords" lay-verify="required" autocomplete="off"
                               class="layui-input">
                        <span>英文逗号区分</span>
                    </div>
                </div>
            </div>
        </fieldset>

        <fieldset class="layui-elem-field" style="background-color: #fff;">
            <legend>行业&字段</legend>
            <div class="layui-field-box">
                <div class="layui-form-item">
                    <button class="layui-btn" type="button" id="addbtn" lay-filter="addbtn"><i class="layui-icon">&#xe61f;</i>添加
                    </button>
                    <table id="table-hy-zd" class="layui-table layui-form">

                    </table>
                    <input type="hidden" name="industryAssociatedFields" id="industryAssociatedFields" autocomplete="off"
                           class="layui-input">

                </div>
            </div>
        </fieldset>


        <div class="layui-form-item">
            <div class="layui-input-block" style="margin: 0 auto;">
                <button class="layui-btn layui-btn-danger" id="cancelbtn" lay-filter="cancel"><i class="layui-icon">&#x1006;</i>取消
                </button>
                <button class="layui-btn" lay-submit lay-filter="add"><i class="layui-icon">&#xe61f;</i>保存</button>
            </div>
        </div>


    </form>
</div>


<script>
    var fid = getParam("fid");
    var id = getParam("id");
    var arr = new Array();         //先声明一维
    //动态添加行
    var i = 0;
    var k = 0;//一维数组下标
    var table = $("#table-hy-zd");
    var pageSize = 10;
    var industryId, industryFieldsId, policiesRegulationsNameSelect;


    function initIndustryFieldSel(industryId, h, cid) {
        var url = apiPath + '/industry/impIndustryFieldsRelease/getIndustryFieldsTree/' + industryId;
        $.ajax({
            type: 'get',
            dataType: 'json',
            contentType: 'application/json',
            url: url,
            async: false,
            success: function (data) {
                //回调需要两个参数, 第一个: 数据数组, 第二个: 总页码
                var k = i - 1; //不减1下边的id比实际大一
                var options = {
                    el: '#industryFieldsId' + h,
                    radio: true,
                    clickClose: true,
                    prop: {
                        name: 'fieldName',
                        value: 'id',
                        children: 'childs'

                    },
                    tree: {
                        show: true,
                        strict: false,
                        expandedKeys: [-1],
                    },
                    data: data.data
                };
                if (cid) {
                    var idArra = new Array();
                    idArra.push(cid);
                    options.initValue = idArra;
                }

                industryFieldsId = xmSelect.render(options);
            },
            error: function () {
            }
        });
    }

    /**
     * iid 目前选中的行业id
     * cid 行业属性id
     */
    function addTr(iid, cid) {

        arr[k] = new Array();
        var m = "industryId" + i;
        var n = "industryFieldsId" + i;
        var table = $("#table-hy-zd");

        var tr = "<tr>\n" +
            "                                <td>行业</td>" +
            "                                <td>" +
            "                                           <div id=" + m + " name=\"industryId\" class=\"xm-select-demo\">\n" +
            "                                           </div>" +
            "                                </td>\n" +
            "                                <td>字段</td>" +
            "                                <td>" +
            "                                           <div id=" + n + " name=\"industryFieldsId\" class=\"xm-select-demo\">\n" +
            "                                           </div>" +
            "                                </td>\n" +
            "                                <td>" +
            "                                   <button type=\"button\" onclick='del(this)' class=\"layui-btn layui-btn-danger del\">删除</button> " +
            "                                </td>\n" +
            "     </tr>";

        table.append(tr);

        var h = i;
        industryFieldsId = xmSelect.render({
            el: '#industryFieldsId' + h,
            radio: true,
            clickClose: true,
            prop: {
                name: 'fieldName',
                value: 'id',
                children: 'childs'

            },
            tree: {
                show: true,
                strict: false,
                expandedKeys: [-1],
            },
        });
        var url = apiPath + '/industry/impIndustryInfo/query_page?size=60';
        $.ajax({
            type: 'get',
            dataType: 'json',
            contentType: 'application/json',
            url: url,
            async: false,
            success: function (data) {
                // cb(, parseInt((data.data.total + pageSize - 1) / pageSize));
                var options = {
                    el: '#industryId' + h,
                    paging: true,
                    pageSize: pageSize,
                    radio: true,
                    filterable: true,
                    clickClose: true,
                    prop: {
                        name: 'name',
                        value: 'id',
                    },
                    data: data.data.records,
                    on: function (data) {
                        //arr:  当前多选已选中的数据
                        var arr = data.arr;
                        //change, 此次选择变化的数据,数组
                        var change = data.change;
                        //isAdd, 此次操作是新增还是删除
                        var isAdd = data.isAdd;
                        if (change && change.length > 0) {
                            var industryId = change[0].id;
                            initIndustryFieldSel(industryId, h);

                        }
                    }
                };

                if (iid) {
                    var idArra = new Array();
                    idArra.push(iid);
                    options.initValue = idArra;
                }
                industryId = xmSelect.render(options);
            },
            error: function () {
            }
        });


        if (cid) {
            initIndustryFieldSel(iid, h, cid);
        }

        arr[k][0] = industryId;
        arr[k][1] = industryFieldsId;

        i++;
        k++;
    }


    function getIndustryFieldsId(industryId, h) {
        var url = apiPath + '/industry/impIndustryFieldsRelease/getIndustryFieldsTree/' + industryId;
        $.ajax({
            type: 'get',
            dataType: 'json',
            contentType: 'application/json',
            url: url,
            success: function (data) {
                //回调需要两个参数, 第一个: 数据数组, 第二个: 总页码
                industryFieldsId = xmSelect.render({
                    el: '#industryFieldsId' + h,
                    radio: true,
                    clickClose: true,
                    prop: {
                        name: 'fieldName',
                        value: 'id',
                        children: 'childs'

                    },
                    tree: {
                        show: true,
                        strict: false,
                        expandedKeys: [-1],
                    },
                    data: data.data
                })
            },
            error: function () {
            }
        });

        // form.render();

    }

    function del(e) {
        var a = e.parentNode.parentNode.rowIndex
        arr.splice(a, 1);
        $(e).closest('tr').remove();
        k--;
    }

    layui.use(['form', 'jquery', 'laydate', 'upload'], function () {
        var form = layui.form;
        var $ = layui.jquery;
        var laydate = layui.laydate;

        var url = apiPath + '/content/impPoliciesInfo/query_page?size=10000';
        $.ajax({
            type: 'get',
            dataType: 'json',
            contentType: 'application/json',
            url: url,
            async: false,
            success: function (data) {
                if (data.code == 0) {
                    policiesRegulationsNameSelect = xmSelect.render({
                        el: '#policiesRegulationsNameSelect',
                        radio: true,
                        filterable: true,
                        clickClose: true,
                        paging: true,
                        pageSize: pageSize,
                        prop: {
                            name: 'policiesName',
                            value: 'id',
                        },
                        on: function (data) {
                            //arr:  当前多选已选中的数据
                            var arr = data.arr;
                            //change, 此次选择变化的数据,数组
                            var change = data.change;
                            //isAdd, 此次操作是新增还是删除
                            var isAdd = data.isAdd;
                            console.log("---xialk--on--------");
                            console.log(change);
                            if (change && change.length > 0) {
                                console.log("---change--on--------");
                                var policiesId = change[0].id;
                                var policiesName = change[0].policiesName;
                                $('#policiesId').val(policiesId);
                                $('#policiesRegulationsName').val(policiesName)
                                form.render();
                            }
                        },
                        // toolbar: { // 工具条配置
                        //     show: true, // 是否显示
                        //     showIcon: false, // 显示图标
                        // },
                        data: data.data.records,
                    })
                }
            },
            error: function () {
                console.log(e.status);
                console.log(e.responseText);
            }
        });

        $.ajax({
            type: 'get',
            url: apiPath + '/content/impPoliciesRegulationsInfo/get/' + id,
            async: false,
            success: function (data) {
                var json = getAjaxData(data);
                form.val("cooperForm", json);
                if (json) {
                    // if (json.policiesRegulationsName) {
                    //     policiesRegulationsNameSelect.setValue([
                    //         {policiesName: json.policiesRegulationsName, id: json.policiesId},
                    //     ])
                    // }
                    if(json.policiesId){
                        var policiesId = json.policiesId;
                        policiesRegulationsNameSelect.setValue([policiesId]);
                    }
                    if (json.impPoliciesFieldsRelations.length > 0) {
                        for (var i = 0; i < json.impPoliciesFieldsRelations.length; i++) {
                            addTr(json.impPoliciesFieldsRelations[i].industryId, json.impPoliciesFieldsRelations[i].industryFieldsId);
                            if (json.impPoliciesFieldsRelations[i].id) {
                                var id = json.impPoliciesFieldsRelations[i].id;
                                arr[i][2] = id;
                            }
                        }

                    } else {
                        addTr();
                    }

                }

            }

        })

        form.on('submit(add)', function (data) {
            //获取当前下拉多选选中的值
            var policiesRegulationsNameSelectArr = policiesRegulationsNameSelect.getValue();
            if(policiesRegulationsNameSelectArr==""){
                alert("政策法规必填，请选择");
                return false;
            }
            data = data.field;
            delete data.select;
            var tableData = getTableContent('table-hy-zd');
            data.id = parseInt(id);
            data.impPoliciesFieldsRelations = tableData;
            data.industryAssociatedFields = $("#industryAssociatedFields").val();
            $.ajax({
                type: 'POST',
                dataType: 'json',
                contentType: 'application/json',
                url: apiPath + '/content/impPoliciesRegulationsInfo/update/' + id,
                data: JSON.stringify(data),
                success: function (res) {
                    if (res && res.code == 0) {
                        top.layer.msg('保存成功');
                        var src = $(top.document).find("iframe[tab-id='" + fid + "']").attr("src");
                        $(top.document).find("iframe[tab-id='" + fid + "']").attr("src", src);
                        // 切换到对应到选项卡下
                        top.element.tabChange('xbs_tab', fid);
                        // 关闭顶层框架tab
                        var id = self.frameElement.getAttribute("tab-id");
                        top.element.tabDelete('xbs_tab', id);
                    } else {
                        top.layer.msg('保存失败');
                    }
                }

            })
            return false;
        });

        $("#addbtn").click(function () {
            addTr();
        });


        $('#cancelbtn').on('click', function () {
            var id = self.frameElement.getAttribute("tab-id");
            top.element.tabDelete('xbs_tab', id);
        });


        function getTableContent(id) {
            var policiesId = $("#policiesId").val();
            var data = [];
            var json;
            var industryAssociatedFields = '';
            for (var i = 0; i < arr.length; i++) {
                json = {};
                for (var j = 0; j < arr[i].length; j++) {
                    if (j == 0 || j == 1) {
                        var value = arr[i][j].getValue('valueStr');
                        var name = arr[i][j].getValue('nameStr');
                    }
                    if (j == 0) {
                        json.industryId = value;
                        industryAssociatedFields += name;
                    } else if (j == 1) {
                        json.industryFieldsId = value;
                        industryAssociatedFields += "(" + name + ")";
                    } else if (j == 2) {
                        json.id = arr[i][2];
                    }
                    json.regulationsId = policiesId;
                    json.createTime = new Date().getTime();
                }
                data.push(json);
            }
            $("#industryAssociatedFields").val(industryAssociatedFields);
            return data;
        }


    });
</script>


</body>
</html>
